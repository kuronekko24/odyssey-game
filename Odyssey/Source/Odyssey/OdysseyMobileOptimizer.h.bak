#pragma once

#include "CoreMinimal.h"
#include "Components/ActorComponent.h"
#include "Engine/World.h"
#include "OdysseyMobileOptimizer.generated.h"

UENUM(BlueprintType)
enum class EPerformanceTier : uint8
{
	High,
	Medium,
	Low
};

USTRUCT(BlueprintType)
struct ODYSSEY_API FMobilePerformanceSettings
{
	GENERATED_BODY()

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance")
	float ViewDistanceScale;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance")
	int32 ShadowQuality;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance")
	float EffectQuality;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance")
	int32 TextureQuality;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance")
	bool bEnableBloom;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance")
	bool bEnableAntiAliasing;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance")
	float RenderScale;

	FMobilePerformanceSettings()
	{
		ViewDistanceScale = 1.0f;
		ShadowQuality = 2;
		EffectQuality = 1.0f;
		TextureQuality = 2;
		bEnableBloom = true;
		bEnableAntiAliasing = true;
		RenderScale = 1.0f;
	}
};

USTRUCT(BlueprintType)
struct ODYSSEY_API FPerformanceMetrics
{
	GENERATED_BODY()

	UPROPERTY(BlueprintReadOnly, Category = "Metrics")
	float CurrentFPS;

	UPROPERTY(BlueprintReadOnly, Category = "Metrics")
	float AverageFPS;

	UPROPERTY(BlueprintReadOnly, Category = "Metrics")
	float MinFPS;

	UPROPERTY(BlueprintReadOnly, Category = "Metrics")
	float MaxFPS;

	UPROPERTY(BlueprintReadOnly, Category = "Metrics")
	float FrameTime;

	UPROPERTY(BlueprintReadOnly, Category = "Metrics")
	int32 DrawCalls;

	UPROPERTY(BlueprintReadOnly, Category = "Metrics")
	int32 TriangleCount;

	FPerformanceMetrics()
	{
		CurrentFPS = 0.0f;
		AverageFPS = 0.0f;
		MinFPS = 0.0f;
		MaxFPS = 0.0f;
		FrameTime = 0.0f;
		DrawCalls = 0;
		TriangleCount = 0;
	}
};

UCLASS(ClassGroup=(Custom), meta=(BlueprintSpawnableComponent))
class ODYSSEY_API UOdysseyMobileOptimizer : public UActorComponent
{
	GENERATED_BODY()

public:
	UOdysseyMobileOptimizer();

protected:
	// Performance settings for different tiers
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance Settings")
	FMobilePerformanceSettings HighPerformanceSettings;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance Settings")
	FMobilePerformanceSettings MediumPerformanceSettings;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Performance Settings")
	FMobilePerformanceSettings LowPerformanceSettings;

	// Current performance state
	UPROPERTY(BlueprintReadOnly, Category = "Performance")
	EPerformanceTier CurrentPerformanceTier;

	UPROPERTY(BlueprintReadOnly, Category = "Performance")
	FPerformanceMetrics PerformanceMetrics;

	// Optimization settings
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Optimization")
	float TargetFPS;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Optimization")
	float FPSThresholdForDowngrade;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Optimization")
	float FPSThresholdForUpgrade;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Optimization")
	float PerformanceCheckInterval;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Optimization")
	bool bEnableAutomaticOptimization;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Optimization")
	bool bEnablePerformanceLogging;

	// Dynamic optimization
	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Dynamic Optimization")
	bool bEnableDynamicLOD;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Dynamic Optimization")
	float LODDistanceScale;

	UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Dynamic Optimization")
	int32 MaxRenderTargets;

	// Performance monitoring
	TArray<float> FPSSamples;
	float PerformanceCheckTimer;
	int32 FPSSampleCount;
	static constexpr int32 MaxFPSSamples = 60; // 2 seconds at 30 FPS

protected:
	virtual void BeginPlay() override;

public:
	virtual void TickComponent(float DeltaTime, ELevelTick TickType, FActorComponentTickFunction* ThisTickFunction) override;

	// Performance management
	UFUNCTION(BlueprintCallable, Category = "Performance")
	
	UFUNCTION(BlueprintCallable, Category = "Performance")
	EPerformanceTier GetCurrentPerformanceTier() const { return CurrentPerformanceTier; }
	void SetPerformanceTier(EPerformanceTier NewTier);

	UFUNCTION(BlueprintCallable, Category = "Performance")
	
	UFUNCTION(BlueprintCallable, Category = "Performance")
	EPerformanceTier GetCurrentPerformanceTier() const { return CurrentPerformanceTier; }
	void OptimizeForCurrentDevice();

	UFUNCTION(BlueprintCallable, Category = "Performance")
	
	UFUNCTION(BlueprintCallable, Category = "Performance")
	EPerformanceTier GetCurrentPerformanceTier() const { return CurrentPerformanceTier; }
	void ApplyPerformanceSettings(const FMobilePerformanceSettings& Settings);

	// Performance monitoring
	UFUNCTION(BlueprintCallable, Category = "Performance")
	
	UFUNCTION(BlueprintCallable, Category = "Performance")
	EPerformanceTier GetCurrentPerformanceTier() const { return CurrentPerformanceTier; }
	FPerformanceMetrics GetCurrentPerformanceMetrics() const { return PerformanceMetrics; }

	UFUNCTION(BlueprintCallable, Category = "Performance")
	
	UFUNCTION(BlueprintCallable, Category = "Performance")
	EPerformanceTier GetCurrentPerformanceTier() const { return CurrentPerformanceTier; }
	float GetAverageFPS() const;

	UFUNCTION(BlueprintCallable, Category = "Performance")
	
	UFUNCTION(BlueprintCallable, Category = "Performance")
	EPerformanceTier GetCurrentPerformanceTier() const { return CurrentPerformanceTier; }
	bool IsPerformanceAcceptable() const;

	// Dynamic optimization
	UFUNCTION(BlueprintCallable, Category = "Dynamic Optimization")
	void UpdateDynamicLOD();

	UFUNCTION(BlueprintCallable, Category = "Dynamic Optimization")
	void OptimizeRenderingForLowPerformance();

	UFUNCTION(BlueprintCallable, Category = "Dynamic Optimization")
	void RestoreNormalRendering();

	// Device detection
	UFUNCTION(BlueprintCallable, Category = "Device Detection")
	bool IsMobileDevice() const;

	UFUNCTION(BlueprintCallable, Category = "Device Detection")
	bool IsLowEndDevice() const;

	UFUNCTION(BlueprintCallable, Category = "Device Detection")
	FString GetDeviceModel() const;

	// Memory optimization
	UFUNCTION(BlueprintCallable, Category = "Memory")
	void OptimizeMemoryUsage();

	UFUNCTION(BlueprintCallable, Category = "Memory")
	void ClearUnusedAssets();

	// Events
	UFUNCTION(BlueprintImplementableEvent, Category = "Performance Events")
	void OnPerformanceTierChanged(EPerformanceTier OldTier, EPerformanceTier NewTier);

	UFUNCTION(BlueprintImplementableEvent, Category = "Performance Events")
	void OnPerformanceThresholdReached(bool bBelowThreshold);

	UFUNCTION(BlueprintImplementableEvent, Category = "Performance Events")
	void OnMemoryWarning();

private:
	void InitializePerformanceSettings();
	void UpdatePerformanceMetrics(float DeltaTime);
	void CheckPerformanceThresholds();
	void AutoOptimizePerformance();
	void LogPerformanceData();
	EPerformanceTier DetermineOptimalPerformanceTier() const;
};
